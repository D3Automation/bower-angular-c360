/**
 * angular-c360 - Angular components for working with data from Configurator 360
 * @version v0.3.0
 * Copyright 2016 D3 Automation.  All Rights Reserved.
 */
!function(){angular.module("angular-c360",["breeze.angular"])}(),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return-1!==r&&r===t}}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),function(){"use strict";function e(e){function t(t,n){var r=n.c360Prop;return t.removeAttr("c360-prop"),t.addClass("c360-prop"),t.attr("ng-model",r+".BoundValue"),t.attr("ng-class","{ 'c360-modified': "+r+".IsModified, 'c360-invalid': "+r+".ErrorInfo }"),t.attr("ng-disabled",r+".IsReadOnly"),t.attr("tooltip","{{"+r+".Tooltip}}"),t.attr("tooltip-popup-delay","1000"),angular.isDefined(t.attr("ng-model-options"))||t.attr("ng-model-options","{ updateOn: "+r+".updateOn }"),"INPUT"!==t[0].nodeName||angular.isDefined(t.attr("type"))||t.attr("type","{{"+r+".inputType}}"),"SELECT"!==t[0].nodeName||angular.isDefined(t.attr("ng-options"))||t.attr("ng-options","choice.value as choice.text for choice in "+r+".ChoiceList"),{pre:function(e,t,n,r){},post:function(t,n,r,a){e(n)(t)}}}return{compile:t,priority:1e3,restrict:"A",terminal:!0}}angular.module("angular-c360").directive("c360Prop",e),e.$inject=["$compile"]}(),function(){"use strict";function e(e,t){var n="c360Viewer";return{restrict:"E",link:function(r,a,i,o){function c(){u.css("z-index","1"),u.offset(a.offset());var e=a.width(),t=e+"px",n=a.height(),r=n+"px";u.css("width",t),u.css("height",r);var i=angular.element(u.children()[0]);i.css("width",t),i.width(e),i.css("height",r),i.height(n)}var u=angular.element("#"+n);r.$on("$destroy",function(t){e.addEventListener("resize",null,!1),u.offset({top:0,left:0}),u.css("z-index","-1")}),e.addEventListener("resize",c,!1),t(function(){c()},100)}}}angular.module("angular-c360").directive("c360Viewer",e),e.$inject=["$window","$timeout"]}(),function(){"use strict";function e(){function e(e,r,a,i,o,c,u,l,s){function f(){a.initialize(B.metadataStore)}function p(){return U()}function d(e){return U(e)}function g(){return j}function m(){return B.getEntities("UIPart")}function h(e){return B.getEntityByKey("UIPart",e)}function y(t,n,r){var a=null,i=e.EntityQuery.from("UIParts").toType("UIPart").where("PartType","==",t),o=B.executeQueryLocally(i),c=o.filter(function(e){return e[n]===r});return c.length>0&&(a=c[0]),a}function v(e,t,n){function a(e){w(e),O(!0),u.resolve()}function c(e){r.error("","Error updating property"),R(e),u.reject()}M=!0;var u=i.defer();return o.$broadcast("C360ModelUpdating",{promise:u.promise}),L.setPropertyValues({refChain:e,properties:[{name:t,value:n}]},a,c),u.promise}function P(e,t){return v(e,t,null)}function C(e){function t(){L.executeAction(e,n,a),o.$broadcast("C360ActionExecuting",{promise:c.promise})}function n(e){var t=null;if(e.url){var n=angular.element("<iframe src='"+e.url+"' style='display: none;' ></iframe>");angular.element("body").append(n),s(function(){n.remove()},1e3),c.resolve()}else if(angular.isDefined(e.title)&&angular.isDefined(e.message)){var t=null;try{t=JSON.parse(e.message)}catch(r){t=e.message}c.resolve(t)}else w(e),O(!0),c.resolve()}function a(t){r.error("","Error occurred while executing action "+e.name),R(payload.data),c.reject(t)}if(A)return r.info("Unable to execute action "+e.name+" while another action is in progress"),i.reject();r.info("Executing action "+e.name);var c=i.defer();return A=!0,c.promise["finally"](function(){A=!1}),e.params?L.setPropertyValues({uiActionParams:JSON.stringify(e.params)},function(){t()}):t(),c.promise}function b(){D()}function N(){return V}function T(){return null!==j}function E(e){e.invalidCharacterReplacement&&angular.isString(e.invalidCharacterReplacement)&&(x.invalidCharacterReplacement=e.invalidCharacterReplacement),e.visitPart&&angular.isFunction(e.visitPart)&&(x.visitPart=e.visitPart),e.isPartCollection&&angular.isFunction(e.isPartCollection)&&(x.isPartCollection=e.isPartCollection),e.parseCollectionName&&angular.isFunction(e.parseCollectionName)&&(x.parseCollectionName=e.parseCollectionName)}function U(e){function t(e){L=e,L.getPropertyValues(null,function(e){w(e),o.$broadcast("C360ModelReset",j),u.resolve(j)})}function r(e){u.reject(e)}D();var a=angular.element("#"+F);if(0===a.length){var c=angular.element("body");a=angular.element('<div id="'+F+'"></div>').prependTo(c)}var u=i.defer(),l={container:a,design:n,panes:!1,success:t,error:r,verbose:!0};return e&&(l.openFromFile=e),$.checkCompatibility(function(e){e.compatible?$.initViewer(l):u.reject(e.reason)}),u.promise}function w(e){I(e,e.parentRefChain),e.removedRefChains&&e.removedRefChains.forEach(function(e){var t=h(e);t&&(t.Parent&&t.Parent.hasOwnProperty(t.Name)&&delete t.Parent[t.Name],B.detachEntity(t))}),S(B.getEntities("UIPart")),o.$broadcast("C360ModelUpdated")}function I(t,n){function r(e){function n(e){return"String"}var r=e.value;try{var a=JSON.parse(r.Tooltip);r.Tooltip=a.ToolTip,r.DataType=a.DataType,r.CustomData=a.CustomData}catch(i){r.DataType=n(r)}return Object.defineProperty(r,"BoundValue",{get:function(){return r.Value},set:function(n){r.Value=n,v(t.refChain,e.name,n)},enumerable:!0,configurable:!0}),Object.defineProperty(r,"inputType",{enumerable:!0,configurable:!1,get:function(){return"Date"===r.DataType?"date":"Boolean"===r.DataType?"checkbox":"Integer"===r.DataType||"Number"===r.DataType?"number":"text"}}),Object.defineProperty(r,"isCheckbox",{enumerable:!0,configurable:!1,get:function(){return"Boolean"===r.DataType}}),Object.defineProperty(r,"hasChoiceList",{enumerable:!0,configurable:!1,get:function(){return null!=r.ChoiceList}}),Object.defineProperty(r,"updateOn",{enumerable:!0,configurable:!1,get:function(){return r.isCheckbox||r.hasChoiceList?"default":"blur"}}),r}var a=null,i=angular.isDefined(t.isCompleteChangedPart)&&t.isCompleteChangedPart===!0;a={RefChain:t.refChain,Name:t.Name,PartType:t.PartType,ParentRefChain:n};var o=B.createEntity("UIPart",a,e.EntityState.Unchanged,e.MergeStrategy.OverwriteChanges);o.UIProperties&&!i||(o.UIProperties=[]),t.properties&&t.properties.forEach(function(e){if(!i)for(var t=0,n=o.UIProperties.length;n>t;t++)if(o.UIProperties[t].FullName===e.value.FullName){o.UIProperties.splice(t,1);break}o.UIProperties.push(r(e))}),o.Messages=t.Messages?t.Messages:[],o.Actions=t.Actions?t.Actions:[],t.children&&t.children.forEach(function(e){I(e,t.refChain)})}function S(e){e.forEach(function(e){"Root"===e.RefChain&&(j=e);var t="_Prop";if(Object.getOwnPropertyNames(e).forEach(function(n){if(n.endsWith(t)){var r=n.replace(t,"");delete e[r],delete e[n]}}),e.UIProperties.forEach(function(n){var r=n.FullName.replace(z,x.invalidCharacterReplacement),a=n;Object.defineProperty(e,r,{get:function(){return a.BoundValue},set:function(e){a.BoundValue=e},enumerable:!0,configurable:!0}),a.reset=function(){P(e.RefChain,a.UiRuleName)};var i=r+t;e[i]=n}),e.Children.forEach(function(t){var n=t.Name.replace(z,x.invalidCharacterReplacement),r=t;Object.defineProperty(e,n,{get:function(){return r},enumerable:!0,configurable:!0})}),x.isPartCollection(e)){var n=x.parseCollectionName(e.Name);Object.defineProperty(e.Parent,n,{get:function(){return e.Children},enumerable:!0,configurable:!0})}e.Actions&&e.Actions.forEach(function(t){e[t.Name]=function(n){var r={refChain:e.RefChain,name:t.Name,params:n};return C(r)}})}),e.forEach(function(e){x.visitPart(e)})}function D(){j=null,B.clear(),O(!1),L&&(L.unload(),L=null)}function R(e){var t={code:0,message:"Server Unavailable",details:""};o.$broadcast("C360Error",{error:t})}function O(e){angular.isDefined(e)||(e=!0),V=e}var $=window.ADSK&&window.ADSK.C360,x=new t,j=null,M=!1,A=!1,V=!1,z=/[\s\%\/\?\)\(\.\']/g,B=new e.EntityManager,L=null,F="c360Viewer";f();var W={getNewModel:p,loadModel:d,getRoot:g,getParts:m,getPartByRefChain:h,getPartByUiProp:y,updateProperty:v,resetProperty:P,executeAction:C,endSession:b,isDirty:N,setDirty:O,isModelLoaded:T,setModelAdapter:E,getViewer:function(){return L}};return W}var n="";this.setDesignKey=function(e){n=e},this.$get=e,e.$inject=["breeze","$log","c360Model","$q","$rootScope","$http","$interval","$window","$timeout"]}function t(){function e(e){return e.Name.endsWith("Collection")}function t(e){var t=e.replace("Collection",""),n=null;return n=t.endsWith("y")?t.substring(0,t.length-1)+"ies":t+"s"}function n(e){}var r=this;r.invalidCharacterReplacement="",r.visitPart=n,r.isPartCollection=e,r.parseCollectionName=t}angular.module("angular-c360").provider("c360Context",e)}(),function(){function e(){function e(e){e.addEntityType({shortName:"UIPart",namespace:"C360",dataProperties:{RefChain:{dataType:t.String,isPartOfKey:!0},Name:{dataType:t.String},PartType:{dataType:t.String},ParentRefChain:{dataType:t.String}},navigationProperties:{Parent:{entityTypeName:"UIPart:#C360",isScalar:!0,associationName:"UIPart_UIPart",foreignKeyNames:["ParentRefChain"]},Children:{entityTypeName:"UIPart:#C360",isScalar:!1,associationName:"UIPart_UIPart"}}})}var t=breeze.DataType;return{initialize:e}}angular.module("angular-c360").factory("c360Model",e)}();