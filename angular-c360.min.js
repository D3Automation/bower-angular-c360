/**
 * angular-c360 - Angular components for working with data from Configurator 360
 * @version v0.5.1
 * (c) 2016 D3 Automation  http://d3tech.net/solutions/automation/
 * License: MIT
 */
function UIProperty(e,t,r){this.c360Context=e,this.hostPart=t,this.adeskProp=r,this.parseChoiceList(),this.parseTooltip()}!function(){angular.module("angular-c360",["breeze.angular"])}(),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){var r=this.toString();(void 0===t||t>r.length)&&(t=r.length),t-=e.length;var n=r.indexOf(e,t);return n!==-1&&n===t}}),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),Object.defineProperty(UIProperty.prototype,"category",{get:function(){return this.adeskProp.Category},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"choiceList",{get:function(){return this.choiceListData},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"choiceListDisplayMode",{get:function(){return this.adeskProp.ChoiceListDisplayMode},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"customData",{get:function(){return this.customDataValue},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"dataType",{get:function(){return this.dataTypeValue},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"errorInfo",{get:function(){return this.adeskProp.ErrorInfo},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"fullName",{get:function(){return this.adeskProp.FullName},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"inputType",{get:function(){return"Date"===this.dataType?"date":"Boolean"===this.dataType?"checkbox":"Integer"===this.dataType||"Number"===this.dataType?"number":"text"},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"invParamName",{get:function(){return this.adeskProp.InvParamName},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"isCheckbox",{get:function(){return"Boolean"===this.dataType},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"isLocked",{get:function(){return this.adeskProp.IsLocked},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"isModified",{get:function(){return this.adeskProp.IsModified},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"isReadOnly",{get:function(){return this.adeskProp.IsReadOnly},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"part",{get:function(){return this.hostPart},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"precision",{get:function(){return this.adeskProp.Precision},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"restrictToList",{get:function(){return this.adeskProp.RestrictToList},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"sequence",{get:function(){return this.adeskProp.Sequence},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"tooltip",{get:function(){return this.adeskProp.Tooltip},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"uiRuleName",{get:function(){return this.adeskProp.UiRuleName},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"updateOn",{get:function(){return this.isCheckbox||this.hasChoiceList?"default":"blur"},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"value",{get:function(){return this.adeskProp.Value},set:function(e){this.adeskProp.Value=e,this.c360Context.updateProperty(this.part.refChain,this.uiRuleName,e)},enumerable:!0,configurable:!0}),Object.defineProperty(UIProperty.prototype,"hasChoiceList",{get:function(){return this.choiceList&&this.choiceList.length>0},enumerable:!0,configurable:!0}),UIProperty.prototype.reset=function(){this.c360Context.resetProperty(this.part.refChain,this.uiRuleName)},UIProperty.prototype.parseChoiceList=function(){this.adeskProp.ChoiceList&&(this.choiceListData=this.adeskProp.ChoiceList.map(function(e){return{value:e.DisplayString,text:e.DisplayString}}))},UIProperty.prototype.parseTooltip=function(){try{var e=JSON.parse(this.adeskProp.Tooltip);this.toolTipValue=e.ToolTip,this.dataTypeValue=e.DataType,this.customDataValue=e.CustomData}catch(t){this.dataTypeValue=this.getDataTypeFromValue()}},UIProperty.prototype.getDataTypeFromValue=function(){return"String"},function(){"use strict";function e(e){function t(t,r){var n=r.c360Prop;return t.removeAttr("c360-prop"),t.addClass("c360-prop"),t.attr("ng-model",n+".value"),t.attr("ng-class","{ 'c360-modified': "+n+".isModified, 'c360-invalid': "+n+".errorInfo }"),t.attr("ng-disabled",n+".isReadOnly"),t.attr("tooltip","{{"+n+".tooltip}}"),t.attr("tooltip-popup-delay","1000"),angular.isDefined(t.attr("ng-model-options"))||t.attr("ng-model-options","{ updateOn: "+n+".updateOn }"),"INPUT"!==t[0].nodeName||angular.isDefined(t.attr("type"))||t.attr("type","{{"+n+".inputType}}"),"SELECT"!==t[0].nodeName||angular.isDefined(t.attr("ng-options"))||t.attr("ng-options","choice.value as choice.text for choice in "+n+".choiceList"),{pre:function(e,t,r,n){},post:function(t,r,n,i){e(r)(t)}}}return{compile:t,priority:1e3,restrict:"A",terminal:!0}}angular.module("angular-c360").directive("c360Prop",e),e.$inject=["$compile"]}(),function(){"use strict";function e(e,t,r){var n="c360Viewer";return{restrict:"E",link:function(i,o,a,c){function u(){s.css("z-index","1"),s.offset(o.offset());var e=o.width(),t=e+"px",r=o.height(),n=r+"px";s.css("width",t),s.css("height",n);var i=angular.element(s.children()[0]);i.css("width",t),i.width(e),i.css("height",n),i.height(r)}var s=angular.element("#"+n);r.componentElement=o,i.$on("$destroy",function(t){e.addEventListener("resize",null,!1),r.componentElement===o&&(s.offset({top:0,left:0}),s.css("z-index","-1"),r.componentElement=void 0)}),e.addEventListener("resize",u,!1),t(function(){u()},100)}}}angular.module("angular-c360").directive("c360Viewer",e),e.$inject=["$window","$timeout","c360ViewerUtils"]}(),function(){"use strict";function e(){function e(e,n,i,o,a,c,u,s,p){function l(){i.initialize(F.metadataStore)}function f(){return E()}function d(e){return E(e)}function y(){return L}function g(){return F.getEntities("UIPart")}function h(e){return F.getEntityByKey("UIPart",e)}function m(t,r,n){var i=null,o=e.EntityQuery.from("UIParts").toType("UIPart").where("PartType","==",t),a=F.executeQueryLocally(o),c=a.filter(function(e){return e[r]===n});return c.length>0&&(i=c[0]),i}function P(e,t,r){function i(e){N(e),x(!0),u.resolve()}function c(e){n.error("","Error updating property"),k(e),u.reject()}$=!0;var u=o.defer();return a.$broadcast("C360ModelUpdating",{promise:u.promise}),z.setPropertyValues({refChain:e,properties:[{name:t,value:r}]},i,c),u.promise}function b(e){function t(e){N(e),x(!0),i.resolve()}function r(e){n.error("","Error updating property"),k(e),i.reject()}$=!0;var i=o.defer();return a.$broadcast("C360ModelUpdating",{promise:i.promise}),z.setPropertyValues(e,t,r),i.promise}function v(e,t){return P(e,t,null)}function C(e){function t(){z.executeAction(e,r,i),a.$broadcast("C360ActionExecuting",{promise:c.promise})}function r(e){var t=null;if(e.url){var r=angular.element("<iframe src='"+e.url+"' style='display: none;' ></iframe>");angular.element("body").append(r),p(function(){r.remove()},1e3),c.resolve()}else if(angular.isDefined(e.title)&&angular.isDefined(e.message)){var t=null;try{t=JSON.parse(e.message)}catch(n){t=e.message}c.resolve(t)}else N(e),x(!0),c.resolve()}function i(t){n.error("","Error occurred while executing action "+e.name),k(payload.data),c.reject(t)}if(M)return n.info("Unable to execute action "+e.name+" while another action is in progress"),o.reject();n.info("Executing action "+e.name);var c=o.defer();return M=!0,c.promise["finally"](function(){M=!1}),e.params?z.setPropertyValues({uiActionParams:JSON.stringify(e.params)},function(){t()}):t(),c.promise}function U(){w()}function I(){return V}function T(){return null!==L}function O(e){e.invalidCharacterReplacement&&angular.isString(e.invalidCharacterReplacement)&&(R.invalidCharacterReplacement=e.invalidCharacterReplacement),e.visitPart&&angular.isFunction(e.visitPart)&&(R.visitPart=e.visitPart),e.isPartCollection&&angular.isFunction(e.isPartCollection)&&(R.isPartCollection=e.isPartCollection),e.parseCollectionName&&angular.isFunction(e.parseCollectionName)&&(R.parseCollectionName=e.parseCollectionName)}function E(e){function t(e){z=e,z.getPropertyValues(null,function(e){N(e),a.$broadcast("C360ModelReset",L),u.resolve(L)})}function n(e){z=e,u.reject(e.state)}w();var i=angular.element("#"+W);if(0===i.length){var c=angular.element("body");i=angular.element('<div id="'+W+'"></div>').prependTo(c)}var u=o.defer(),s={container:i,design:r,panes:!1,success:t,error:n,verbose:!0};return e&&(s.openFromFile=e),D.checkCompatibility(function(e){e.compatible?D.initViewer(s):(K=e.reason,u.reject(e.reason))}),u.promise}function N(e){K=null,j(e,e.parentRefChain),e.removedRefChains&&e.removedRefChains.forEach(function(e){var t=h(e);t&&(t.Parent&&t.Parent.hasOwnProperty(t.Name)&&delete t.Parent[t.Name],F.detachEntity(t))}),S(F.getEntities("UIPart")),a.$broadcast("C360ModelUpdated")}function j(t,r){var n=null,i=angular.isDefined(t.isCompleteChangedPart)&&t.isCompleteChangedPart===!0;n={refChain:t.refChain,name:t.Name,partType:t.PartType,parentRefChain:r};var o=F.createEntity("UIPart",n,e.EntityState.Unchanged,e.MergeStrategy.OverwriteChanges);o.actions&&o.actions.forEach(function(e){delete o[e.name]}),o.uiProperties&&o.uiProperties.forEach(function(e){delete o[e.fullName]}),o.uiProperties&&!i||(o.uiProperties=[]),t.properties&&t.properties.forEach(function(e){if(!i)for(var t=0,r=o.uiProperties.length;t<r;t++)if(o.uiProperties[t].FullName===e.value.FullName){o.uiProperties.splice(t,1);break}o.uiProperties.push(new UIProperty(B,o,e.value))}),o.messages=[],t.Messages&&t.Messages.forEach(function(e){o.messages.push({messageText:e.MessageText,severity:e.Severity})}),o.actions=[],t.Actions&&t.Actions.forEach(function(e){o.actions.push({name:e.Name,category:e.Category,menuText:e.MenuText,tooltip:e.tooltip})}),t.children&&t.children.forEach(function(e){j(e,t.refChain)})}function S(e){e.forEach(function(e){if("Root"===e.refChain&&(L=e),e.uiProperties.forEach(function(t){var r=t.fullName.replace(A,R.invalidCharacterReplacement);e[r]=t}),e.children.forEach(function(t){var r=t.name.replace(A,R.invalidCharacterReplacement),n=t;Object.defineProperty(e,r,{get:function(){return n},enumerable:!0,configurable:!0})}),R.isPartCollection(e)){var t=R.parseCollectionName(e.name);Object.defineProperty(e.parent,t,{get:function(){return e.children},enumerable:!0,configurable:!0})}e.actions&&e.actions.forEach(function(t){e[t.name]=function(r){var n={refChain:e.refChain,name:t.name,params:r};return C(n)}})}),e.forEach(function(e){R.visitPart(e)})}function w(){L=null,F.clear(),x(!1),z&&(z.unload(),z=null)}function k(e){var t={code:0,message:"Server Unavailable",details:""};a.$broadcast("C360Error",{error:t})}function x(e){angular.isDefined(e)||(e=!0),V=e}var D=window.ADSK&&window.ADSK.C360,R=new t,L=null,$=!1,M=!1,V=!1,A=/[\s\%\/\?\)\(\.\']/g,F=new e.EntityManager,z=null,K=null,W="c360Viewer";l();var B={getNewModel:f,loadModel:d,getRoot:y,getParts:g,getPartByRefChain:h,getPartByUiProp:m,updateProperty:P,updateProperties:b,resetProperty:v,executeAction:C,endSession:U,isDirty:I,setDirty:x,isModelLoaded:T,setModelAdapter:O,getViewer:function(){return z},getLastError:function(){return K}};return B}var r="";this.setDesignKey=function(e){r=e},this.$get=e,e.$inject=["breeze","$log","c360Model","$q","$rootScope","$http","$interval","$window","$timeout"]}function t(){function e(e){return e.name.endsWith("Collection")}function t(e){var t=e.replace("Collection",""),r=null;return r=t.endsWith("y")?t.substring(0,t.length-1)+"ies":t+"s"}function r(e){}var n=this;n.invalidCharacterReplacement="",n.visitPart=r,n.isPartCollection=e,n.parseCollectionName=t}angular.module("angular-c360").provider("c360Context",e)}(),function(){function e(){function e(e){e.addEntityType({shortName:"UIPart",namespace:"C360",dataProperties:{refChain:{dataType:t.String,isPartOfKey:!0},name:{dataType:t.String},partType:{dataType:t.String},parentRefChain:{dataType:t.String}},navigationProperties:{parent:{entityTypeName:"UIPart:#C360",isScalar:!0,associationName:"UIPart_UIPart",foreignKeyNames:["parentRefChain"]},children:{entityTypeName:"UIPart:#C360",isScalar:!1,associationName:"UIPart_UIPart"}}})}var t=breeze.DataType;return{initialize:e}}angular.module("angular-c360").factory("c360Model",e)}(),function(){"use strict";function e(){return{componentElement:void 0}}angular.module("angular-c360").factory("c360ViewerUtils",e)}();